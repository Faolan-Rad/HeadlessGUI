<!DOCTYPE html>
<html>
   <head id="head">
      <script type="text/javascript" src="./Resources/DOMediting.js"></script>
      <script>
         const $ = require('jquery')
         require('bootstrap')
      </script>
      <title>Config</title>
   </head>
   <body>
      <div id="alerts">
      </div>
      <ul class="nav nav-tabs">
         <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" href="#system">System</a>
         </li>
         <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#visual">Visual</a>
         </li>
         <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#account">Account</a>
         </li>
         <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#server">Servers</a>
         </li>
         <li class="nav-item" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Coming Soon!">
            <a class="nav-link disabled" >Presets</a>
         </li>
         <li class="nav-item">
            <a class="nav-link text-danger" data-toggle="tab" href="#danger">Danger Zone</a>
         </li>
      </ul>
      <div id="myTabContent" class="tab-content">
          <!--SYSTEM-->
         <div class="tab-pane fade active show" id="system">
               <div class="form-group">
                    <label for="usernameOverride">Server Display Name</label>
                    <input type="text" class="form-control" id="usernameOverride" aria-describedby="emailHelp" placeholder="Display Username">
                    <label for="allowedUrlHosts">Networking Hosts Allowed</label>
                    <textarea rows=3 type="text" id="allowedUrlHosts" class="form-control" placeholder="URI Hosts; Comma Delimited"></textarea>
                  <label for="custom-file">Headless Client</label>
                  <div class="custom-file">
                     <input type="file" accept=".exe" class="custom-file-input" id="NeosClient" onchange="setFileDisplay(this.files[0].path)" webkitdirectory />
                     <label class="custom-file-label" id="clientText" for="NeosClient">Browse for Folder</label>
                  </div>
                  <div class='form-group' id="PathFormGroup">
                     <input type="text" class="form-control" id="NeosClientPath" aria-describedby="emailHelp" placeholder="Path" onchange="validatePath()">
                     <div id="PathFeedback" class="invalid-feedback"></div>
                  </div>
               </div>
               <div class="modal-footer"><button type="button" class="btn btn-primary" type="submit" onclick="saveConfig(this.parentElement.parentElement.id)">Save System</button></div>
         </div>
         <!--VISUAL-->
         <div class="tab-pane fade" id="visual">
            
            <div>
                    <button type="button" class="btn btn-primary">Primary</button>
                    <button type="button" class="btn btn-secondary">Secondary</button>
                    <button type="button" class="btn btn-success">Success</button>
                    <button type="button" class="btn btn-info">Info</button>
                    <button type="button" class="btn btn-warning">Warning</button>
                    <button type="button" class="btn btn-danger">Danger</button>
                    <button type="button" class="btn btn-link">Link</button>
                    <div class="alert alert-dismissible alert-warning">
                            <button type="button" class="close" data-dismiss="alert">&times;</button>
                            <h4 class="alert-heading">Warning!</h4>
                            <p class="mb-0">Best check yo self, you're not looking too good. Nulla vitae elit libero, a pharetra augue. Praesent commodo cursus magna, <a href="#" class="alert-link">vel scelerisque nisl consectetur et</a>.</p>
                          </div>
                          <div class="alert alert-dismissible alert-danger">
                                <button type="button" class="close" data-dismiss="alert">&times;</button>
                                <strong>Oh snap!</strong> <a href="#" class="alert-link">Change a few things up</a> and try submitting again.
                              </div>
                              <div class="alert alert-dismissible alert-success">
                                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                                    <strong>Well done!</strong> You successfully read <a href="#" class="alert-link">this important alert message</a>.
                                  </div>
                                  <div class="alert alert-dismissible alert-info">
                                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                                        <strong>Heads up!</strong> This <a href="#" class="alert-link">alert needs your attention</a>, but it's not super important.
                                      </div>
                                      <span class="badge badge-primary">Primary</span>
<span class="badge badge-secondary">Secondary</span>
<span class="badge badge-success">Success</span>
<span class="badge badge-danger">Danger</span>
<span class="badge badge-warning">Warning</span>
<span class="badge badge-info">Info</span>
<span class="badge badge-light">Light</span>
<span class="badge badge-dark">Dark</span>
<ul class="list-group">
        <li class="list-group-item d-flex justify-content-between align-items-center">
          Cras justo odio
          <span class="badge badge-primary badge-pill">14</span>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
          Dapibus ac facilisis in
          <span class="badge badge-primary badge-pill">2</span>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
          Morbi leo risus
          <span class="badge badge-primary badge-pill">1</span>
        </li>
      </ul>
            </div>
            <br>
            <div>
                    <label for="SelectTheme">Theme</label>
                    <select id="SelectTheme" class="custom-select" onchange="newThemeFunc()">
                    </select>
                 </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" type="submit" onclick="saveConfig(this.parentElement.parentElement.id)">Save Visual</button></div>
         </div>
         <!--ACCOUNT-->
         <div class="tab-pane fade" id="account"> 
            <label for="ProfileDisplay">Neos Account</label>
            <div id='ProfileDisplay' style="display: none;">
               <img id="ProfilePicture" src="https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_960_720.png" style="float:left; width:75px; height: 75px; padding-right: 5px; border-radius: 50%;">
               <h3 id="userNameProfile">[Loading...]</h3>
               <button type="button" class="btn btn-outline-danger btn-sm" onclick="callLogout()">Logout</button>
            </div>
            <div id="Login" style="display: none;">
               <button type="button" class="btn btn-info" onclick="callLogin()">Login to Neos</button>
            </div>
            <label for="apikey">PolyLogiX Api Key</label>
            <input type="password" class="form-control" id="apikey" placeholder="Optional">
            <small id="apikeyhelp" class="form-text text-muted">API Key for communicating with your PolyLogiX Account</small>
            <small id="apikeyhelp" class="form-text text-muted">NOT YET IMPLIMENTED</small>
            <div class="modal-footer"><button type="button" class="btn btn-primary" type="submit" onclick="saveConfig(this.parentElement.parentElement.id)">Save Account</button></div>
         </div>
         <!--SERVER-->
         <div class="tab-pane fade" id="server">
            
                <label for="tickRate">Server Tick Rate</label>
                <input type="number" id="tickRate" class="form-control" placeholder="Frame Rate" min="24" max="1024" value="60">
            <div class="modal-footer"><button type="button" class="btn btn-primary" type="submit" onclick="saveConfig(this.parentElement.parentElement.id)">Save Server</button></div>
         </div>
         <!--DANGER ZONE-->
         <div class="tab-pane fade" id="danger">
            <button type="button" class="btn btn-outline-danger disabled" type="submit" onclick="">Wipe HeadlessCore Data (Disabled)</button>
         </div>
      </div>
      <script>
         const electron = require('electron')
         const {
             ipcRenderer
         } = electron;
         const Store = require('electron-store');
         const store = new Store({name: 'dat'});
         const config = new Store({name: 'config'});
         const themes = new Store({name: 'themes'});
         const fs = require('fs')
         const path = require('path');
         const fetch = require('node-fetch')
         var pathValid = false
         var neosToken = store.get('NEOS:token')
         
         $(document).ready(function () {
             generateThemeTable()
             getConfig();
         
         /* if no Token stored, display Login Button, Else get user info*/
         if (!neosToken) {
             $('#Login').css("display",'block')
         } else {
             login()
             $('#ProfileDisplay').css("display",'block')
         }
         
         });
         
         
         
         
         
         function callLogin() {
             ipcRenderer.send('callWindow:Login')
         }
         ipcRenderer.on("NEOS:Login", (e) => {
             login()
             $('#ProfileDisplay').css("display",'block')
             $('#Login').css("display",'none')
         })
         
         function callLogout() {
             fetch(`api/userSessions/${store.get('NEOS:userId')}/${store.get('NEOS:token')}`,{method:"DELETE",headers:{'neos':`${store.get('NEOS:userId')}:${store.get('NEOS:token')}`}}) // Invalidate Token
             store.delete('NEOS:token')
             store.delete('NEOS:userId')
             store.delete('NEOS:token:expire')
             config.delete('loginCredentials')
             config.delete('loginPassword')
             $('#ProfileDisplay').css("display",'none')
             $('#Login').css("display",'block')
             ipcRenderer.send('NEOS:Logout')
         }
         /* Fetch Neos Account Profile Info */
         function login() {
             fetch(`https://cloudx.azurewebsites.net/api/users/${store.get('NEOS:userId')}`)
                 .then(res => res.json())
                 .then(json => {
                     $('#userNameProfile').html(json.username)
                     let str = json.profile.iconUrl
                     var hash = str.substring(
                         str.lastIndexOf("/") + 1,
                         str.lastIndexOf("."))
                     $('#ProfilePicture').attr('src',`https://cloudxstorage.blob.core.windows.net/assets/${hash}`)
         
                 })
         
         }
         /* Cut File path and Validate */
         function setFileDisplay(FilePath) {
             let folder = FilePath.split('\\')
             $('#NeosClientPath').val(FilePath.substring(0, FilePath.lastIndexOf('\\') + 1))
             $('#clientText').innerHTML = folder[folder.length - 2]
             validatePath()
         }
         //Make sure Valid directory to Neos.EXE
         function validatePath() {
             if (fs.existsSync(path.join($('#NeosClientPath').val(), 'Neos.exe'))) {
                 $('#NeosClientPath').attr('class', 'form-control is-valid')
                 $('#PathFeedback').attr('class', 'valid-feedback')
                 $('#PathFeedback').html('Headless Client Found!')
                 pathValid = true
             } else {
                 $('#NeosClientPath').attr('class', 'form-control is-invalid')
                 $('#PathFeedback').attr('class', 'invalid-feedback')
                 $('#PathFeedback').html('Headless Client not found!')
                 pathValid = false
             }
         
         }
         
         function getConfig() {
             let hosts = config.get('allowedUrlHosts')
         
             if (!store.has('configSet')) {
                 return
             }
             $('#tickRate').val(config.get('tickRate'))
             $('#NeosClientPath').val(config.get('neosClientPath'))
             $('#usernameOverride').val(config.get('usernameOverride'))
             $('#apikey').val(config.get('PolyLogiXAPI'))
             if (hosts) {
                 $('#allowedUrlHosts').val(hosts.join(',\r\n'))
             }
             validatePath()
         }
         
         /* Theme Swapping */
         var oldTheme = undefined
         var newTheme = undefined
         
         function newThemeFunc() {
             oldTheme = (newTheme ? newTheme : config.get('currentTheme'))
             newTheme = $("#SelectTheme").val()
             replacejscssfile(themes.get(`Themes.${oldTheme}.url`), themes.get(`Themes.${newTheme}.url`), 'css')
         }
         /* Update Store with Info */
         function saveConfig(element) {
             switch(element){
                 case 'system':
                 config.set('neosClientPath', $('#NeosClientPath').val())
                 break
                 case 'visual':
                 store.set('oldTheme', config.get('currentTheme'))
                 config.set('currentTheme', $("#SelectTheme").val())
                 break
                 case 'account':
                 config.set('PolyLogiXAPI', $('#apikey').val())
                 break
                 case 'server':
                 config.set('tickRate', $('#tickRate').val())
             
                config.set('usernameOverride', $('#usernameOverride').val())
             
                let hosts = $('#allowedUrlHosts').val()
                 hosts = hosts.replace(/\s/g, '');
                 hosts = hosts.replace(/\r\n[\r]\n/g, '')
                 config.set('allowedUrlHosts', (!hosts) ? null : hosts.split(','))
                 break
             }
             store.set('configSet', true)
             
         
             
             ipcRenderer.send('Config:Update');
         }
         function generateThemeTable(){
             console.log('Generating Theme Table')
             let table = themes.get('Themes');
             console.log(table)
             let options = Object.keys(table);
         /* Genetate Theme Options from Store */
         
             let innerText = ``
         for (let i = 0; i < options.length; i++) {
             innerText+=("<option " + (options[i] == config.get('currentTheme') ? 'selected ' : '') + "value=\"" + options[i] + "\">" + options[i] + "</option>")
         }
         $("#SelectTheme").html(innerText)
         }
      </script>
   </body>
</html>