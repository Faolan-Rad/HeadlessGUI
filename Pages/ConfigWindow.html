<!DOCTYPE html>
<html>

<head id="head">
    <script type="text/javascript" src="./Resources/DOMediting.js"></script>
    <title>Config</title>
</head>

<body>
    <div id="alerts">
    </div>
    <form>
        <div class="form-group">
            <label for="ProfileDisplay">Neos Account</label>
            <div id='ProfileDisplay' style="display: none;">
                <img id="ProfilePicture" src="https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_960_720.png" style="float:left; width:75px; height: 75px; padding-right: 5px; border-radius: 50%;">
                <h3 id="userNameProfile">[Loading...]</h3>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="callLogout()">Logout</button>
            </div>
            <div id="Login" style="display: none;">
                <button type="button" class="btn btn-info" onclick="callLogin()">Login to Neos</button>
            </div>
            <label for="usernameOverride">Display Name</label>
            <input type="text" class="form-control" id="usernameOverride" aria-describedby="emailHelp" placeholder="Display Username">

            <label for="apikey">PolyLogiX Api Key</label>
            <input type="password" class="form-control" id="apikey" placeholder="Optional">
            <small id="apikeyhelp" class="form-text text-muted">API Key for communicating with your PolyLogiX Account</small>
            <small id="apikeyhelp" class="form-text text-muted">NOT YET IMPLIMENTED</small>
            <label for="tickRate">Server Tick Rate</label>
            <input type="number" id="tickRate" class="form-control" placeholder="User Limit" min="24" max="1024" value="60">
            <label for="custom-file">Headless Client</label>
            <div class="custom-file">=
                <input type="file" accept=".exe" class="custom-file-input" id="NeosClient" onchange="setFileDisplay(this.files[0].path)" webkitdirectory />
                <label class="custom-file-label" id="clientText" for="NeosClient">Browse for Folder</label>
            </div>
            <div class='form-group' id="PathFormGroup">
                <input type="text" class="form-control" id="NeosClientPath" aria-describedby="emailHelp" placeholder="Path" onchange="validatePath()">
                <div id="PathFeedback" class="invalid-feedback"></div>
            </div>
            <label for="allowedUrlHosts">Networking Hosts Allowed</label>
            <textarea rows=3 type="text" id="allowedUrlHosts" class="form-control" placeholder="URI Hosts; Comma Delimited"></textarea>
        </div>

        <div>
            <div>
                <label for="SelectTheme">Theme</label>
                    <select id="SelectTheme"  class="custom-select" onchange="newThemeFunc()">
                    </select>
            </div>
                <div class="modal-footer"></div>
            <button type="button" class="btn btn-primary" type="submit" onclick="saveConfig()">Save changes</button>
        </div>
    </form>
    <script>
        const electron = require('electron')
        const {
            ipcRenderer
        } = electron;
        const Store = require('electron-store');
        const store = new Store();
        const fs = require('fs')
        const path = require('path');
        const fetch = require('node-fetch')
        var pathValid = false

        var neosToken = store.get('NEOS:token')


        if (!neosToken) {
            document.getElementById('Login').style.display = 'block'
        } else {
            login()
            document.getElementById('ProfileDisplay').style.display = 'block'
        }

        function callLogin() {
            ipcRenderer.send('callWindow:Login')
        }
        ipcRenderer.on("NEOS:Login", (e)=>{
            login()
            document.getElementById('ProfileDisplay').style.display = 'block'
            document.getElementById('Login').style.display = 'none'
        })
        function callLogout(){
            store.delete('NEOS:token')
            store.delete('NEOS:userId')
            store.delete('NEOS:token:expire')
            document.getElementById('ProfileDisplay').style.display = 'none'
            document.getElementById('Login').style.display = 'block'
            ipcRenderer.send('NEOS:Logout')
        }
        function login() {
            fetch(`https://cloudx.azurewebsites.net/api/users/${store.get('NEOS:userId')}`)
            .then(res => res.json())
            .then(json => {
                document.getElementById('userNameProfile').innerHTML = json.username
                let str = json.profile.iconUrl
                var hash = str.substring(
                    str.lastIndexOf("/") + 1, 
                    str.lastIndexOf("."))
                    document.getElementById('ProfilePicture').src = `https://cloudxstorage.blob.core.windows.net/assets/${hash}`

            })

        }

        function setFileDisplay(FilePath) {
            //console.log(FilePath)
            let folder = FilePath.split('\\')
            //console.log(folder)
            document.getElementById('NeosClientPath').value = FilePath.substring(0, FilePath.lastIndexOf('\\') + 1);
            document.getElementById('clientText').innerHTML = folder[folder.length - 2]
            validatePath()
        }

        function validatePath() {
            if (fs.existsSync(path.join(document.getElementById('NeosClientPath').value, 'Neos.exe'))) {
                document.getElementById('NeosClientPath').setAttribute('class', 'form-control is-valid')
                document.getElementById('PathFeedback').setAttribute('class', 'valid-feedback')
                document.getElementById('PathFeedback').innerHTML = 'Headless Client Found!'
                pathValid = true
            } else {
                document.getElementById('NeosClientPath').setAttribute('class', 'form-control is-invalid')
                document.getElementById('PathFeedback').setAttribute('class', 'invalid-feedback')
                document.getElementById('PathFeedback').innerHTML = 'Headless Client not found!'
                pathValid = false
            }

        }

        function getConfig() {
            let hosts = store.get('allowedUrlHosts')

            if (!store.has('configSet')) {
                return
            }
            document.getElementById('tickRate').value = store.get('tickRate')
            document.getElementById('NeosClientPath').value = store.get('neosClientPath')
            document.getElementById('usernameOverride').value = store.get('usernameOverride')
            //loginCredential=store.get('neos:loginCredential')
            //loginPassword=store.get('neos:loginPassword')
            document.getElementById('apikey').value = store.get('PolyLogiXAPI')
            if (hosts) {
                document.getElementById('allowedUrlHosts').value = hosts.join(',\r\n')
            }
            validatePath()
        }
        var oldTheme = undefined
        var newTheme = undefined
        function newThemeFunc(){
            oldTheme = (newTheme?newTheme:store.get('currentTheme'))
            newTheme = document.getElementById("SelectTheme").value
            replacejscssfile(store.get(`Themes.${oldTheme}.url`), store.get(`Themes.${newTheme}.url`), 'css')
        }
        function saveConfig() {
            store.set('configSet', true)
            store.set('tickRate', document.getElementById('tickRate').value)
            store.set('neosClientPath', document.getElementById('NeosClientPath').value)
            store.set('usernameOverride', document.getElementById('usernameOverride').value)
            store.set('PolyLogiXAPI', document.getElementById('apikey').value)
            let hosts = document.getElementById('allowedUrlHosts').value
            hosts = hosts.replace(/\s/g, '');
            hosts = hosts.replace(/\r\n[\r]\n/g, '')
            store.set('allowedUrlHosts', (!hosts) ? null : hosts.split(','))
            
            store.set('oldTheme',store.get('currentTheme'))
            store.set('currentTheme',document.getElementById("SelectTheme").value)
            ipcRenderer.send('Config:Update');
        }
        let select = document.getElementById("SelectTheme"); 
        let table = store.get('Themes');
        let options = Object.keys(table);
        for (let i = 0; i < options.length; i++) {select.innerHTML += ("<option "+(options[i]==store.get('currentTheme')?'selected ':'')+"value=\"" + options[i] + "\">" + options[i] + "</option>");}
        getConfig();

        


    </script>
</body>

</html>